<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Slugs & Dinos</title>
    <link rel="stylesheet" href="./assets/reset.css" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Bungee+Shade" rel="stylesheet">
    <link rel="stylesheet" href="./assets/index.css" type="text/css">
    <link rel="stylesheet" href="./external/jquery-ui.min.css">
    <link rel="icon" type="image/gif" href="assets/images/favicon.ico">
    <link rel="stylesheet" href="./assets/font-awesome-4.7.0/css/font-awesome.min.css">
    <script src="./external/jquery/jquery.js"></script>
    <script src="./external/jquery-ui.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="./assets/javascripts/bundle.js"></script>

    <script>
      function dragstart_handler(ev) {
        $(ev.target).attr("id", "selected");
        console.log("dragStart");
        // Add the target element's id to the data transfer object
        const data = event.dataTransfer;
        // data.setDataAt("image/png", stream, 0);
        // data.setDataAt("application/x-moz-file", file, 0);
        // data.setData("text/uri-list", ev.target.src);
        // data.setData("text/uri-plain", ev.target.src);
        ev.dataTransfer.setData("text/plain", ev.target.id);
        var img = new Image();
        img.src = 'assets/images/four-expand-arrows.png';
        ev.dataTransfer.setDragImage(img, 10, 10);
        ev.dataTransfer.dropEffect = "move";

      }

      function dragover_handler(ev) {
       ev.preventDefault();
       // Set the dropEffect to move
       ev.dataTransfer.dropEffect = "move"
      }

    function drop_handler(ev) {
       ev.preventDefault();
       // Get the id of the target and add the moved element to the target's DOM
       var data = ev.dataTransfer.getData("text");
       if (!data){

         dragstart_handler(ev);
       }

       const toElement = $(ev.target.parentElement);
       const image = ev.target.src.slice(52);

       const fromElement = $(document.getElementById(data).parentElement)


       toElement.html("").append(document.getElementById(data))
       fromElement.append(`<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=${image} height="54px" >`)
       $(document.getElementById(data)).removeAttr('id')

       checkHorizontals();
      // findTargets($(fromElement))
    }

    function checkInside() {
      for (let idx = 0; idx < 64; idx++) {
        const borderIndicies = [0, 1, 2, 3, 4, 5, 6, 7, 8, 15, 16, 23, 24, 31, 32, 39, 40, 47, 48, 55, 56, 57, 58, 59, 60, 61, 62, 63]
        if (borderIndicies.includes(idx)) {
          continue;
        }
        const $clickedCreature = $(`ul.group li:eq(${idx})`)
        // this.checkMatches($clickedCreature);
        debugger
        this.findTargets($clickedCreature);
      }
      // for (let idx = 0; idx < 64; idx++) {
      //   const $clickedCreature = $(`ul.group li:eq(${idx})`)
      //   // this.checkMatches($clickedCreature);
      //   debugger
      //   findTargets($clickedCreature);
      // }
    }

      function findTargets($clickedCreature) {
        const clickedCreatureIdx = $($clickedCreature).index();
        debugger
        const deltas = [-9, -8, -7, -1, 1, 7, 8, 9];

        let possibleTargets = []

        deltas.forEach((delta) => {
          return possibleTargets.push(clickedCreatureIdx + delta)
        });

        findMatches(possibleTargets, $clickedCreature);
      }


      function findMatches(possibleTargets, $clickedCreature) {
        const matches = []
        const borderIndicies = [0, 1, 2, 3, 4, 5, 6, 7, 8, 15, 16, 23, 24, 31, 32, 39, 40, 47, 48, 55, 56, 57, 58, 59, 60, 61, 62, 63]
        possibleTargets.forEach( function (index) {
          if ($clickedCreature.html() === $(`ul.group li:eq(${index})`).html() && !borderIndicies.includes(index)) {
            matches.push($( `ul.group li:eq(${index})`));
            return matches
          }
        })
        checkMatches(matches, $clickedCreature)
      }


    function checkMatches(matches, $clickedCreature) {

      matches.forEach( function (match) {
        const diff = $clickedCreature.index() - $(match).index();
        const possibleThirdIdx = $(match).index() - diff;
        const possibleThird = ($(`ul.group li:eq(${possibleThirdIdx})`));

        if ($(match).html() === $(possibleThird).html()) {
          const images = ['bluedino.png', 'slug.png', 'slug1.png', 'dino2.png', 'rex.png'];
          const newHTML = `img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" `
          const matchThree = [$(match), $clickedCreature, possibleThird];
          // let score = 0;
          matchThree.forEach( function (element) {
            element.html("").html("<img src='assets/images/explosion.png' width='57px'>")
            setTimeout(function(){ element.html("").html(`<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=assets/images/${images[(Math.floor(Math.random() * 5)) % 5]} height="54px" >`); },2000)
            // score += 10
          })

          debugger
          // console.log(score)
        }

      })
    }

    function checkHorizontals() {
      let noMatches = false
      // while (!noMatches) {
        // noMatches = true
        const horizontalIndicies = [0, 1, 2, 3, 4, 5, 56, 57, 58, 59, 60, 61]

        horizontalIndicies.forEach((idx) => {
          const $currentCreature = $(`ul.group li:eq(${idx})`)
          const $firstCheck = $(`ul.group li:eq(${idx+1})`)
          const $secondCheck = $(`ul.group li:eq(${idx+2})`)
  debugger
          if ($currentCreature.html() === $firstCheck.html() && $currentCreature.html() === $secondCheck.html()) {
            noMatches = false;
            const images = ['bluedino.png', 'slug1.png', 'slug.png', 'dino2.png', 'rex.png'];
            const newHTML = `<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=assets/images/${images[(Math.floor(Math.random() * 5)) % 5]} height="54px" >`
            $currentCreature.html("").html(`<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=assets/images/${images[(Math.floor(Math.random() * 5)) % 5]} height="54px" >`);
            $firstCheck.html("").html(`<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=assets/images/${images[(Math.floor(Math.random() * 5)) % 5]} height="54px" >`);
            $secondCheck.html("").html(`<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=assets/images/${images[(Math.floor(Math.random() * 5)) % 5]} height="54px" >`);
          }
        })
      // }
        checkVerticals();
        // this.checkMatches($clickedCreature);
        debugger
    }

  function checkVerticals () {
    const verticalIndicies = [0, 8, 16, 24, 32, 40, 15, 23, 31, 39, 47]
    // const rightVerticalIndicies = [15, 23, 31, 39, 47, 55]
  debugger
      verticalIndicies.forEach((idx) => {
        const $currentCreature = $(`ul.group li:eq(${idx})`)
        const $firstCheck = $(`ul.group li:eq(${idx+8})`)
        const $secondCheck = $(`ul.group li:eq(${idx+16})`)

        if ($currentCreature.html() === $firstCheck.html() && $currentCreature.html() === $secondCheck.html()) {
          const images = ['dino2.png', 'rex.png', 'bluedino.png', 'slug1.png', 'slug.png'];
          const newHTML = `<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=assets/images/${images[(Math.floor(Math.random() * 5)) % 5]} height="54px" >`
          $currentCreature.html("").html(`<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=assets/images/${images[(Math.floor(Math.random() * 5)) % 5]} height="54px" >`);
          $firstCheck.html("").html(`<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=assets/images/${images[(Math.floor(Math.random() * 5)) % 5]} height="54px" >`);
          $secondCheck.html("").html(`<img draggable="true" ondrop="drop_handler(event);" ondragover="dragover_handler(event);" ondragstart="dragstart_handler(event);" src=assets/images/${images[(Math.floor(Math.random() * 5)) % 5]} height="54px" >`);
        }
      })
      checkInside();
    }

    // handleScore(score) {
    //   if (!totalScore) {
    //     let totalScore = 0;
    //   } else {
    //     totalScore += score
    //   }
    //   return totalScore;
    //   console.log(totalScore)
    // }

    </script>

  </head>
  <body>
    <div class="gamescreen">

			<div class="links">
				<a href="https://www.linkedin.com/in/ellie-wawrzaszek/" class="fa fa-linkedin"></a>
        <a href="https://github.com/ewawrzas" class="fa fa-github"></a>
				<a href="https://angel.co/ellie-wawrzaszek" class="fa fa-angellist"></a>
			</div>
    <div class="wrapper1">

        <div class="header">
          <img id="dinoImg1" src="./assets/images/rex.svg">
          <h1 id="title">Slugs & Dinos</h1>
          <img id="dinoImg2" src="./assets/images/rex.svg">
        </div>

        <div class="content">
          <div class="control-panel-column">
            <button id="start" type="button" name="button">START</button>
            <div class="scoreDiv">
              <img id="eggImg" src="./assets/images/egg.svg">
              <h2 id="label">Score</h2>
            </div>

            <div id="progressBar"></div>

          </div>
          <figure class="gameboard"></figure>
        </div>

      </div>
    </div>
  </body>
</html>
